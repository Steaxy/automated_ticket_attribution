name: deploy-dev

on:
  push:
    tags:
      - "*-dev"

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Ensure tag commit is on dev branch
        shell: bash
        run: |
          set -euo pipefail
          git fetch origin dev --prune
          TAG_COMMIT="$(git rev-parse HEAD)"
          git merge-base --is-ancestor "${TAG_COMMIT}" "origin/dev"

      - uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: "pip"

      - name: Quality gates
        run: |
          pip install -r requirements.txt
          pip install -r requirements-dev.txt
          make lint
          make type-check
          make test

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_DEPLOY_ROLE_ARN }}
          aws-region: ${{ vars.AWS_REGION }}

      - name: Build & push Docker image to ECR
        shell: bash
        run: |
          set -euo pipefail

          TAG="${GITHUB_REF_NAME}"
          AWS_REGION="${{ vars.AWS_REGION }}"

          # NEW: fail-fast if GitHub variables are missing
          AWS_ACCOUNT_ID="${{ vars.AWS_ACCOUNT_ID }}"
          ECR_REPO="${{ vars.ECR_REPO }}"
          : "${AWS_ACCOUNT_ID:?Missing vars.AWS_ACCOUNT_ID}"
          : "${ECR_REPO:?Missing vars.ECR_REPO}"

          ECR_REGISTRY="${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com"
          IMAGE_URI="${ECR_REGISTRY}/${ECR_REPO}:${TAG}"

          aws ecr get-login-password --region "${AWS_REGION}" \
            | docker login --username AWS --password-stdin "${ECR_REGISTRY}"

          docker build -t "${IMAGE_URI}" .
          docker push "${IMAGE_URI}"

          echo "IMAGE_URI=${IMAGE_URI}" >> "$GITHUB_ENV"

      - name: Package source (deploy bundle)
        shell: bash
        run: |
          set -euo pipefail

          TAG="${GITHUB_REF_NAME}"
          OUT="/tmp/atta-${TAG}.tar.gz"

          tar \
            --exclude='./.git' \
            --exclude='./.venv' \
            --exclude='./venv' \
            --exclude='./output' \
            --exclude='./__pycache__' \
            --exclude='./.pytest_cache' \
            --exclude='./.mypy_cache' \
            --exclude='./.ruff_cache' \
            -czf "${OUT}" .

          mv "${OUT}" "atta-${TAG}.tar.gz"

      - name: Upload artifact to S3
        shell: bash
        run: |
          set -euo pipefail
          TAG="${GITHUB_REF_NAME}"
          BUCKET="${{ vars.DEPLOY_BUCKET }}"
          aws s3 cp "atta-${TAG}.tar.gz" "s3://${BUCKET}/atta/${TAG}/atta-${TAG}.tar.gz"

      - name: Deploy on EC2 via SSM Run Command
        shell: bash
        run: |
          set -euo pipefail

          TAG="${GITHUB_REF_NAME}"
          INSTANCE_ID="${{ vars.DEV_EC2_INSTANCE_ID }}"
          AWS_REGION="${{ vars.AWS_REGION }}"
          ATTA_IMAGE="${IMAGE_URI}"

          aws ssm send-command \
            --instance-ids "${INSTANCE_ID}" \
            --document-name "AWS-RunShellScript" \
            --comment "Pre-pull ATTA image ${TAG}" \
            --parameters commands="[
              \"set -euo pipefail\",
              \"export AWS_REGION='${AWS_REGION}'\",
              \"export AWS_DEFAULT_REGION='${AWS_REGION}'\",
              \"export ATTA_IMAGE='${ATTA_IMAGE}'\",
              \"echo 'ATTA_IMAGE='\\\"${ATTA_IMAGE}\\\"'\",\

              \"command -v docker >/dev/null 2>&1 || sudo dnf -y install docker\",
              \"sudo systemctl enable --now docker\",

              \"AWS_ACCOUNT_ID=$(echo ${ATTA_IMAGE} | cut -d. -f1)\",
              \"ECR_REGISTRY=${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com\",

              \"aws ecr get-login-password --region ${AWS_REGION} | sudo docker login --username AWS --password-stdin ${ECR_REGISTRY}\",
              \"sudo docker pull ${ATTA_IMAGE}\",
              \"sudo docker images | head -20\"
            ]"